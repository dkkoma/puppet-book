## 第2章: 本書の方針

本書は、Puppet入門書としてはやや変わった構成を採っています。本章では、なぜそのような方針で構成したのかについて説明します。

### 本書の方針

「はじめに」で述べた通り、本書の目標は、この本を読んだ読者がPuppetの基本についてひととおり知り、オペレーションエンジニアの書いたmanifestに変更を加えたり、ある程度の規模のものなら自力でいちから書けるようになったりすることです。

そのため、膨大なPuppetの機能のうち、本質的な知識にのみ焦点をあてて説明します。といっても、実践を軽んじているということではまったくなく、むしろその逆で、読了と同時、あるいは、本書を読みながら、読者が実際にPuppetを始められることを目指しています。

本書の方針は、上述の「すぐに実践できる知識についてのみ説明する」の他、以下の通り挙げられます。

  1. agent/master構成を採らない
  2. node情報を管理しない
  3. 標準的なディレクトリ構成を用いない

それぞれについて説明します。

### agent/master構成を採らない

Puppetには「agent/masterモード」と呼ばれる構成があります。agentとは、構成管理の対象となるサーバ(nodeと呼ばれます)、正確には、そのnode上で動くクライアントプログラムです。一方masterとは、nodeとは独立に存在し、agentからのリクエストに応えてコンパイルされたmanifest(catalogと呼ばれます)を配布する役割を担います。

[Puppet Labsの公式ドキュメント](http://docs.puppetlabs.com/learning/agent_master_basic.html)に掲載されている以下の図を見ると、容易にイメージできるでしょう。

![Puppetはagent/masterからなる](../images/02-agent-master.png)

本書では、このagent/master構成を採用しません。理由は以下の通りです。

  1. agent/master構成は大規模なクラスタには有用だが、小規模なサービスの場合はなくても事足りる
  2. masterの設定や運用はそれなりに難しい
  3. 将来、本当に必要になった時にagent/master構成へスイッチすればいい

本書は、Puppetのmanifestをそれぞれのnode上で個別に適用する方式、具体的には`puppet apply`コマンドのみを使う方法を採ります(Chefをご存知の方は、Chef Soloを想起するとわかりやすいでしょう)。まず小さな規模から実践したいという本書の目的からいって、じゅうぶん理に叶った方針であると考えます。

### node情報を管理しない

Puppetのagent/master構成では、nodeをホスト名に基づいて識別し、それぞれについてどのような状態が適用されるべきかという記述を行います。具体的には、以下のような記述があったとして、

```
node 'app001.example.com' {
  # app001用の設定
}

node 'db001.example.com' {
  # db001用の設定
}
```

`app001.example.com`のagentと、`db001.example.com`のagentとで設定を分けることで、特定のnodeに対して特定のmanifestを適用できます。

これは便利な機能ではある一方、以下の理由により本書では採りません。

  1. agent/master構成を採用しないので使えない
  2. node情報は別の場所で管理したい

2については、具体的にはあとの章で説明する通り、[capistrano](http://capistranorb.com/)で実現します。本書の説明に従ってmanifestを書いていけば、capistrano + `puppet apply`コマンドで、小規模環境なら十分に機能する道具立てがそろいます。

### 標準的なディレクトリ構成を用いない

第1章でChefとの比較において述べた通り、Puppetはディレクトリ構成において、Chefより比較的自由です。そのため、manifestを気をつけて構成していかないと、保守性に乏しいものになってしまいがちです。

本書では、Puppetのベストプラクティスを適宜参照することでそうした混沌を避けつつ、保守性の高いかっちりした構成と、上記で述べてきたような実践の容易さとを両立する方法を紹介します。

### まとめ

本章では、本書の方針と、なぜそのような方針を採用するのかについて説明しました。

構成管理というと、大規模なクラスタのためのものというイメージが強く、Puppetももちろんそのような要件に対応するべく開発が進められてきたのですが、それだけではもったいないというのが筆者の考えです。

本書の方針は、Puppetによる構成管理の自動化と、その学習・運用コストをてんびんにかけ、両方のいいとこ取りが可能な、適切なバランスであると考えます。
